package protocol

import (
	"encoding/json"
	"errors"
	"fmt"

	"github.com/gucooing/BaPs/mx"
	"github.com/gucooing/BaPs/mx/cmd"
	"github.com/gucooing/BaPs/mx/proto"
)

type NetworkProtocolResponse struct {
	Packet   string `json:"packet"`   // 包数据
	Protocol string `json:"protocol"` // 协议名称
}

// UnmarshalRequest 解码req数据包
func UnmarshalRequest(b []byte) (mx.Message, *mx.BasePacket, error) {
	base := new(mx.BasePacket)
	err := json.Unmarshal(b, base)
	if err != nil {
		return nil, nil, err
	}
	packet := cmd.Get().GetRequestPacketByCmdId(base.GetProtocol())
	if packet == nil {
		return nil, nil, errors.New(fmt.Sprintf("request unknown cmd id: %v", base.GetProtocol()))
	}
	err = json.Unmarshal(b, packet)
	if err != nil {
		return nil, nil, err
	}

	return packet, base, nil
}

// MarshalResponse 编码rsp数据包
func MarshalResponse(m mx.Message) (*NetworkProtocolResponse, error) {
	if m == nil {
		return nil, errors.New("message nil")
	}
	jsonData, err := json.Marshal(m)
	if err != nil {
		return nil, err
	}
	v := &NetworkProtocolResponse{
		Packet:   string(jsonData),
		Protocol: proto.Protocol(m.GetProtocol()).String(),
	}
	switch m.GetProtocol() {
	// case 1017:
	// 	v.Packet = "{\"Protocol\":1017,\"CafeGetInfoResponse\":{\"Protocol\":20000,\"CafeDBs\":[{\"CafeDBId\":3937788,\"CafeId\":1,\"AccountId\":1,\"CafeRank\":1,\"LastUpdate\":\"2025-01-13T15:24:36\",\"LastSummonDate\":\"0001-01-01T00:00:00\",\"IsNew\":true,\"CafeVisitCharacterDBs\":{\"16000\":{\"UniqueId\":16000},\"16007\":{\"UniqueId\":16007},\"10031\":{\"UniqueId\":10031}},\"FurnitureDBs\":[{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"ItemDeploySequence\":569370020,\"ServerId\":569370020,\"UniqueId\":1,\"StackCount\":1},{\"Type\":13,\"Location\":4,\"CafeDBId\":3937788,\"ItemDeploySequence\":569370021,\"ServerId\":569370021,\"UniqueId\":2,\"StackCount\":1},{\"Type\":13,\"Location\":3,\"CafeDBId\":3937788,\"ItemDeploySequence\":569370022,\"ServerId\":569370022,\"UniqueId\":3,\"StackCount\":1},{\"Type\":13,\"Location\":4,\"CafeDBId\":3937788,\"PositionX\":8.5,\"PositionY\":3.0,\"ItemDeploySequence\":569370023,\"ServerId\":569370023,\"UniqueId\":4,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":3.0,\"PositionY\":1.5,\"Rotation\":270.0,\"ItemDeploySequence\":569370024,\"ServerId\":569370024,\"UniqueId\":5,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":8.5,\"ItemDeploySequence\":569370025,\"ServerId\":569370025,\"UniqueId\":6,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":6.5,\"ItemDeploySequence\":569370026,\"ServerId\":569370026,\"UniqueId\":7,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":9.5,\"PositionY\":8.5,\"ItemDeploySequence\":569370027,\"ServerId\":569370027,\"UniqueId\":8,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":4.5,\"PositionY\":0.5,\"ItemDeploySequence\":569370028,\"ServerId\":569370028,\"UniqueId\":9,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":8.5,\"ItemDeploySequence\":569370029,\"ServerId\":569370029,\"UniqueId\":10,\"StackCount\":1},{\"Type\":13,\"Location\":3,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":3.0,\"ItemDeploySequence\":569370030,\"ServerId\":569370030,\"UniqueId\":11,\"StackCount\":1}],\"ProductionAppliedTime\":\"2024-12-24T21:30:22\",\"ProductionDB\":{\"CafeDBId\":3937788,\"AppliedDate\":\"2024-12-24T21:30:22\",\"ProductionParcelInfos\":[{\"Key\":{\"Type\":2,\"Id\":1}},{\"Key\":{\"Type\":2,\"Id\":5}}]}}],\"FurnitureDBs\":[{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"ItemDeploySequence\":569370020,\"ServerId\":569370020,\"UniqueId\":1,\"StackCount\":1},{\"Type\":13,\"Location\":4,\"CafeDBId\":3937788,\"ItemDeploySequence\":569370021,\"ServerId\":569370021,\"UniqueId\":2,\"StackCount\":1},{\"Type\":13,\"Location\":3,\"CafeDBId\":3937788,\"ItemDeploySequence\":569370022,\"ServerId\":569370022,\"UniqueId\":3,\"StackCount\":1},{\"Type\":13,\"Location\":4,\"CafeDBId\":3937788,\"PositionX\":8.5,\"PositionY\":3.0,\"ItemDeploySequence\":569370023,\"ServerId\":569370023,\"UniqueId\":4,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":3.0,\"PositionY\":1.5,\"Rotation\":270.0,\"ItemDeploySequence\":569370024,\"ServerId\":569370024,\"UniqueId\":5,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":8.5,\"ItemDeploySequence\":569370025,\"ServerId\":569370025,\"UniqueId\":6,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":6.5,\"ItemDeploySequence\":569370026,\"ServerId\":569370026,\"UniqueId\":7,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":9.5,\"PositionY\":8.5,\"ItemDeploySequence\":569370027,\"ServerId\":569370027,\"UniqueId\":8,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":4.5,\"PositionY\":0.5,\"ItemDeploySequence\":569370028,\"ServerId\":569370028,\"UniqueId\":9,\"StackCount\":1},{\"Type\":13,\"Location\":2,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":8.5,\"ItemDeploySequence\":569370029,\"ServerId\":569370029,\"UniqueId\":10,\"StackCount\":1},{\"Type\":13,\"Location\":3,\"CafeDBId\":3937788,\"PositionX\":7.5,\"PositionY\":3.0,\"ItemDeploySequence\":569370030,\"ServerId\":569370030,\"UniqueId\":11,\"StackCount\":1}]},\"AccountCurrencySyncResponse\":{\"Protocol\":1003,\"AccountCurrencyDB\":{\"AccountLevel\":1,\"AcademyLocationRankSum\":1,\"CurrencyDict\":{\"Gem\":600,\"GemPaid\":0,\"GemBonus\":600,\"Gold\":10000,\"ActionPoint\":24,\"AcademyTicket\":3,\"ArenaTicket\":5,\"RaidTicket\":3,\"WeekDungeonChaserATicket\":0,\"WeekDungeonChaserBTicket\":0,\"WeekDungeonChaserCTicket\":0,\"SchoolDungeonATicket\":0,\"SchoolDungeonBTicket\":0,\"SchoolDungeonCTicket\":0,\"TimeAttackDungeonTicket\":3,\"MasterCoin\":0,\"WorldRaidTicketA\":40,\"WorldRaidTicketB\":40,\"WorldRaidTicketC\":40,\"ChaserTotalTicket\":6,\"SchoolDungeonTotalTicket\":6,\"EliminateTicketA\":4,\"EliminateTicketB\":4,\"EliminateTicketC\":4,\"EliminateTicketD\":4},\"UpdateTimeDict\":{\"ActionPoint\":\"2024-12-24T21:30:22\",\"AcademyTicket\":\"2024-12-24T21:30:22\",\"ArenaTicket\":\"2024-12-24T21:30:22\",\"RaidTicket\":\"2024-12-24T21:30:22\",\"WeekDungeonChaserATicket\":\"2024-12-24T21:30:22\",\"WeekDungeonChaserBTicket\":\"2024-12-24T21:30:22\",\"WeekDungeonChaserCTicket\":\"2024-12-24T21:30:22\",\"SchoolDungeonATicket\":\"2024-12-24T21:30:22\",\"SchoolDungeonBTicket\":\"2024-12-24T21:30:22\",\"SchoolDungeonCTicket\":\"2024-12-24T21:30:22\",\"TimeAttackDungeonTicket\":\"2024-12-24T21:30:22\",\"MasterCoin\":\"2024-12-24T21:30:22\",\"WorldRaidTicketA\":\"2024-12-24T21:30:22\",\"WorldRaidTicketB\":\"2024-12-24T21:30:22\",\"WorldRaidTicketC\":\"2024-12-24T21:30:22\",\"ChaserTotalTicket\":\"2024-12-24T21:30:22\",\"SchoolDungeonTotalTicket\":\"2024-12-24T21:30:22\",\"EliminateTicketA\":\"2025-01-13T15:24:36\",\"EliminateTicketB\":\"2025-01-13T15:24:36\",\"EliminateTicketC\":\"2025-01-13T15:24:36\",\"EliminateTicketD\":\"2025-01-13T15:24:36\"}},\"ExpiredCurrency\":{}},\"CharacterListResponse\":{\"Protocol\":2000,\"CharacterDBs\":[{\"Type\":1,\"ServerId\":1864403357,\"UniqueId\":13003,\"StarGrade\":2,\"Level\":1,\"FavorRank\":1,\"PublicSkillLevel\":1,\"ExSkillLevel\":1,\"PassiveSkillLevel\":1,\"ExtraPassiveSkillLevel\":1,\"LeaderSkillLevel\":1,\"EquipmentServerIds\":[0,0,0],\"PotentialStats\":{\"1\":0,\"2\":0,\"3\":0}},{\"Type\":1,\"ServerId\":1864403355,\"UniqueId\":13010,\"StarGrade\":2,\"Level\":1,\"FavorRank\":1,\"PublicSkillLevel\":1,\"ExSkillLevel\":1,\"PassiveSkillLevel\":1,\"ExtraPassiveSkillLevel\":1,\"LeaderSkillLevel\":1,\"EquipmentServerIds\":[0,0,0],\"PotentialStats\":{\"1\":0,\"2\":0,\"3\":0}},{\"Type\":1,\"ServerId\":1864403356,\"UniqueId\":16003,\"StarGrade\":1,\"Level\":1,\"FavorRank\":1,\"PublicSkillLevel\":1,\"ExSkillLevel\":1,\"PassiveSkillLevel\":1,\"ExtraPassiveSkillLevel\":1,\"LeaderSkillLevel\":1,\"EquipmentServerIds\":[0,0,0],\"PotentialStats\":{\"1\":0,\"2\":0,\"3\":0}},{\"Type\":1,\"ServerId\":1864403358,\"UniqueId\":26000,\"StarGrade\":1,\"Level\":1,\"FavorRank\":1,\"PublicSkillLevel\":1,\"ExSkillLevel\":1,\"PassiveSkillLevel\":1,\"ExtraPassiveSkillLevel\":1,\"LeaderSkillLevel\":1,\"EquipmentServerIds\":[0,0,0],\"PotentialStats\":{\"1\":0,\"2\":0,\"3\":0}}],\"TSSCharacterDBs\":[],\"WeaponDBs\":[],\"CostumeDBs\":[]},\"EquipmentItemListResponse\":{\"Protocol\":3000,\"EquipmentDBs\":[]},\"CharacterGearListResponse\":{\"Protocol\":44000,\"GearDBs\":[]},\"EchelonListResponse\":{\"Protocol\":5000,\"EchelonDBs\":[{\"AccountServerId\":80363213,\"EchelonType\":1,\"EchelonNumber\":1,\"LeaderServerId\":1864403355,\"MainSlotServerIds\":[1864403355,1864403356,1864403357,0],\"SupportSlotServerIds\":[1864403358,0],\"SkillCardMulliganCharacterIds\":[],\"CombatStyleIndex\":[0,0,0,0,0,0]}]},\"MemoryLobbyListResponse\":{\"Protocol\":12000,\"MemoryLobbyDBs\":[]},\"CampaignListResponse\":{\"Protocol\":6000,\"StageHistoryDBs\":[]},\"ArenaLoginResponse\":{\"Protocol\":22001,\"ArenaPlayerInfoDB\":{\"DailyRewardActiveTime\":\"9999-12-31T23:59:59.9999999\"}},\"RaidLoginResponse\":{\"Protocol\":17018,\"SeasonType\":2,\"ServerNotification\":8},\"EliminateRaidLoginResponse\":{\"Protocol\":45000,\"SeasonType\":2,\"ServerNotification\":8},\"CraftInfoListResponse\":{\"Protocol\":21000},\"ClanLoginResponse\":{\"Protocol\":28001,\"AccountClanMemberDB\":{\"AccountId\":1}},\"MomotalkOutlineResponse\":{\"Protocol\":33000},\"ScenarioListResponse\":{\"Protocol\":19000},\"ShopGachaRecruitListResponse\":{\"Protocol\":10006},\"TimeAttackDungeonLoginResponse\":{\"Protocol\":39006},\"BillingPurchaseListByYostarResponse\":{\"Protocol\":29002,\"CountList\":[],\"OrderList\":[],\"MonthlyProductList\":[],\"BlockedProductDBs\":[]},\"EventContentPermanentListResponse\":{\"Protocol\":30041,\"PermanentDBs\":[{\"EventContentId\":900801},{\"EventContentId\":900802},{\"EventContentId\":900803},{\"EventContentId\":900804},{\"EventContentId\":900805},{\"EventContentId\":900806},{\"EventContentId\":900808},{\"EventContentId\":900809},{\"EventContentId\":900810},{\"EventContentId\":900812},{\"EventContentId\":900813},{\"EventContentId\":900814},{\"EventContentId\":900816},{\"EventContentId\":900817},{\"EventContentId\":900818},{\"EventContentId\":900825},{\"EventContentId\":900701},{\"EventContentId\":900815}]},\"AttachmentGetResponse\":{\"Protocol\":46000},\"AttachmentEmblemListResponse\":{\"Protocol\":46001,\"EmblemDBs\":[{\"Type\":20,\"UniqueId\":1,\"ReceiveDate\":\"2024-12-24T21:30:22\"},{\"Type\":20,\"UniqueId\":2,\"ReceiveDate\":\"2024-12-24T21:30:22\"},{\"Type\":20,\"UniqueId\":3,\"ReceiveDate\":\"2024-12-24T21:30:22\"},{\"Type\":20,\"UniqueId\":4,\"ReceiveDate\":\"2024-12-24T21:30:22\"},{\"Type\":20,\"UniqueId\":5,\"ReceiveDate\":\"2024-12-24T21:30:22\"}]},\"ContentSweepMultiSweepPresetListResponse\":{\"Protocol\":27002,\"MultiSweepPresetDBs\":[]},\"StickerListResponse\":{\"Protocol\":47000,\"StickerBookDB\":{\"AccountId\":1,\"UnusedStickerDBs\":[],\"UsedStickerDBs\":[]}},\"MultiFloorRaidSyncResponse\":{\"Protocol\":49000,\"MultiFloorRaidDBs\":[{\"SeasonId\":10,\"ClearBattleFrame\":-1}]},\"FriendCode\":\"BNAGBIES\",\"ServerTimeTicks\":638723790900000000,\"ServerNotification\":8,\"StaticOpenConditions\":{\"Shop\":0,\"Gacha\":0,\"LobbyIllust\":0,\"Raid\":2,\"Cafe\":2,\"Unit_Growth_Skill\":0,\"Unit_Growth_LevelUp\":0,\"Unit_Growth_Transcendence\":0,\"WeekDungeon\":2,\"Arena\":2,\"Academy\":2,\"Equip\":0,\"Item\":0,\"Mission\":0,\"WeekDungeon_Chase\":2,\"__Deprecated_WeekDungeon_FindGift\":0,\"__Deprecated_WeekDungeon_Blood\":0,\"Story_Sub\":0,\"Story_Replay\":0,\"None\":0,\"Shop_Gem\":0,\"Craft\":2,\"Student\":0,\"GuideMission\":0,\"Clan\":2,\"Echelon\":0,\"Campaign\":0,\"EventContent\":0,\"EventStage_1\":2,\"EventStage_2\":0,\"Talk\":0,\"Billing\":0,\"Schedule\":0,\"Story\":0,\"Tactic_Speed\":2,\"Cafe_Invite\":2,\"Cafe_Invite_2\":18,\"EventMiniGame_1\":2,\"SchoolDungeon\":2,\"TimeAttackDungeon\":2,\"ShiftingCraft\":2,\"Tactic_Skip\":2,\"Mulligan\":2,\"EventPermanent\":2,\"Main_L_1_2\":32,\"Main_L_1_3\":32,\"Main_L_1_4\":32,\"EliminateRaid\":2,\"Cafe_2\":2,\"MultiFloorRaid\":2,\"StrategySkip\":2,\"MinigameDreamMaker\":2,\"MiniGameDefense\":2}}"
	}

	return v, nil
}
